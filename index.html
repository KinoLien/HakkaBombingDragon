<!DOCTYPE html>
<html>
  <head>
  	<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=no">
  	<meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

  	<link rel="stylesheet" type="text/css" href="css/dragon.css" />
  	<script type="text/javascript" src="js/jquery-1.11.3.min.js"></script>
  	<style type="text/css">
  		/*@media (min-width: 768px) {
  			.navbar-form .form-control{
  				width: 320px;
  			}
  			.table-path{
  				font-size: 16px;
    			margin: 6px 0;
  			}
  			.table-path > .glyphicon{
  				margin-right: 5px;
  			}
  		}
  		.loading{
  			margin: 7px 5px;
  			display: none;
  		}

		.container-scroll{
			overflow:auto;
		}
  		.glyphicon-refresh-animate {
		    -animation: spin .7s infinite linear;
		    -webkit-animation: spin2 .7s infinite linear;
		}

		@-webkit-keyframes spin2 {
		    from { -webkit-transform: rotate(0deg);}
		    to { -webkit-transform: rotate(360deg);}
		}

		@keyframes spin {
		    from { transform: scale(1) rotate(0deg);}
		    to { transform: scale(1) rotate(360deg);}
		}*/
  	</style>
  	<script>
		// document.getElementById('stage_1').addEventListener('mousemove', function(e){
		// var x = e.offsetX==undefined?e.layerX:e.offsetX;
		// var y = e.offsetY==undefined?e.layerY:e.offsetY;
		// console.log(x + " " + y);
		// });
		
		window.TimeBar = (function(){
		  var _instances = {};

		  var timebarInstance = function(id){
		    this._jqel = $('#'+id);
		    this._int = null;
		    this._curs = 10.0;
		    this._sec = 10.0;
		    this._changeBegin = (1 / 3) * 100;
		    this._changeEnd = (1 / 15) * 100;
		    this._changeInt = this._changeBegin - this._changeEnd;
		  };

		  timebarInstance.prototype._stopInterval = function(){
		    if(this._int){
		      clearInterval(this._int);
		      this._int = null;
		    }
		  };

		  timebarInstance.prototype.clearBar = function(){
		    this._stopInterval();
		    this._curs = 0.0;
		    this._jqel.css("width", "0%").attr('aria-valuenow', 0);
		  };

		  timebarInstance.prototype.resetBar = function(){
		    this._stopInterval();
		    this._curs = this._sec;
		    // this._jqel.css("width", "100%").css("background-color", '#ffff00').attr('aria-valuenow', 100);
		    this._jqel.css("width", "100%").attr('aria-valuenow', 100);
		  };

		  timebarInstance.prototype.doStop = function(toClear, stopCallback){
		    this._stopInterval();
		    if(toClear){
		      this.clearBar();
		    }
		    if(typeof stopCallback == 'function'){
		    	stopCallback.call(this);
		    }
		  };

		  timebarInstance.prototype.doStart = function(stopCallback){
		    if(this._curs && this._int == null){
		      this._int = setInterval((function(scope){
		        return function(){
		          var s = parseFloat(scope._curs).toFixed(1);
		          if (s > 0){
		            scope._curs = s - 0.1;
		            var percent = 100 * scope._curs / scope._sec;
		            scope._jqel.css("width", percent+"%").attr('aria-valuenow', percent);
		            // if(percent >= scope._changeBegin){
		            //   scope._jqel.css("background-color", '#ffff00');
		            // }else if(percent > scope._changeEnd && percent < scope._changeBegin){
		            //   var percentInGreen = parseInt((percent - scope._changeEnd) / scope._changeInt * 255);
		            //   scope._jqel.css("background-color", '#ff'+ percentInGreen.toString(16) +'00');
		            // }else{
		            //   scope._jqel.css("background-color", '#ff0000');
		            // }
		          } else {
		            scope.doStop(undefined, stopCallback);
		          }
		        };
		      })(this), 100);
		    }
		  };

		  timebarInstance.prototype.setSecond = function(s){
		    if(this._int == null && !isNaN(s)){
		      this._sec = parseFloat(s).toFixed(1);
		      this._curs = this._sec;
		    }
		  };

		  timebarInstance.prototype.setSize = function(width, height){

		  };

		  var _getIns = function(id){
		    if(!_instances[id]){
		      _instances[id] = new timebarInstance(id);
		    }
		    return _instances[id];
		  };
		  return {
		    getInstanceById: _getIns
		  };
		})();

		window.stage1Process = {
			_processInterval: null,
			_showInterval: null,
			_fireworkProcessAll: [],
			_fireworkShowing: [],
			_fireworkPositions: [
				120, 20, 348, 0, 590, 0, 385, 210, 320, 369, 590, 260
			],
			_hasInitialized: false,
			_getValidIndex: function(){
				var min = 0,
					len = this._fireworkProcessAll.length,
					max = len - 1;
				if(len){
					return Math.floor(Math.random() * (max - min + 1) + min);
				}				
				return -1;
			},
			init: function(){
				if(this._hasInitialized == false){
					var stage1El = $('#stage_1');
					var fp = this._fireworkPositions;
					for(var i = 0, j = 0, len = fp.length; i < len; i+=2, j++){
						var str = '<div class="intro-firework" style="left:' + fp[i] + 'px;top:'
							+ fp[i+1] + 'px;" f-n="' + (j+1) + '">' +
		  					'<img width="100%" /></div>';
						stage1El.append(str);
					}

					this._hasInitialized = true;
				}
			},
			start: function(){
				if(!this._processInterval && !this._showInterval){
					this._showInterval = {};
					this._showCacheTempMaps = {};
					var fws = document.querySelectorAll(".intro-firework");
					for(var i = 0, len = fws.length; i < len; i++){
						var item = fws[i];
						var id = item.getAttribute('f-n');
						this._showCacheTempMaps[id] = item;
						this._fireworkProcessAll.push(id);
					}
					this._processInterval = setInterval((function(scope){
						return function(){	
							var imageUrl = "images/01-intro-firework.gif";

							var processFn = function(startStamp){
								var scope = this;
								return function(){
									var idx = scope._getValidIndex();
									var itemId = scope._fireworkProcessAll.splice(idx, 1)[0];
									scope._fireworkShowing.push(itemId);
									$(scope._showCacheTempMaps[itemId]).show();
									$(scope._showCacheTempMaps[itemId]).children(":first-child").attr('src', imageUrl);
									scope._showInterval[itemId] = setTimeout((function(id, outerScope){
										return function(){
											outerScope.stop(id);
											// console.log(id + " stop show");
										}
									})(itemId, scope), startStamp + 800);
									// console.log(itemId + " start show");
								};
							};

							setTimeout(processFn.call(scope, 100), 100);
							setTimeout(processFn.call(scope, 100), 100);
						};
					})(this), 1000);	
				}
			},
			stop: function(itemId){
				var showingIndex;
				if(!this._hasInitialized) return;
				var imageUrl = "images/01-intro-firework-stop.png";
				if(typeof itemId == 'undefined'){
					$(".intro-firework").hide();
					$(".intro-firework").children(":first-child").attr('src', imageUrl);
					clearInterval(this._processInterval);
					for(var i in this._showInterval){
						clearInterval(this._showInterval[i]);
					}
					this._processInterval = null;
					this._showInterval = null;
					this._showCacheTempMaps = null;
					this._fireworkProcessAll = [];
					this._fireworkShowing = [];
				}else if((showingIndex = this._fireworkShowing.indexOf(itemId)) != -1 && this._showInterval[itemId]){
					clearInterval(this._showInterval[itemId]);
					this._showInterval[itemId] = null;
					$(this._showCacheTempMaps[itemId]).hide();
					$(this._showCacheTempMaps[itemId]).children(":first-child").attr('src', imageUrl);
					// $("[" + this._bombAttrSelector + "=" + itemId + "]").hide();
					// back to all
					this._fireworkShowing.splice(showingIndex, 1);
					// console.log("stop and push: " + itemId);
					this._fireworkProcessAll.push(itemId);
					// console.log(this._fireworkProcessAll);
				}
			}
		};

		window.stage2Process = {
			_hasInitialized:false,
			_textDom: null,
			_showInterval: null,
			_textStr: "這裡放一些文字，點點點。",
			init:function(){
				if(this._hasInitialized == false){
					var stageEl = $('#stage_2');
					this._textDom = stageEl.children(":last-child");
					this._hasInitialized = true;
				}
			},
			start:function(){
				var scope = this;
				scope._showInterval = {};
				$(".message-dialog").fadeIn({
					complete:function(){
						var text = scope._textStr;
						for(var i = 0, len = text.length; i < len; i++){
							scope._showInterval[i.toString()] = setTimeout((function(str, dom){
								return function(){
									var textNode = document.createTextNode(str);
        							dom.append(textNode);
								};
							})(text[i], scope._textDom), (i+1) * 200);

							// automatically jump
							if(i + 1 == len){
								scope._showInterval["auto"] = setTimeout(function(){
									gamer.toNext();		
								}, i * 200 + 4000);
							}
						}
					}
				});
			},
			stop:function(){
				for(var i in this._showInterval){
					clearInterval(this._showInterval[i]);
				}
				this._showInterval = null;
				this._textDom.empty();
			}
		};

		window.stage3Process = {
			_hasInitialized:false,
			_textDom: null,
			_showInterval: null,
			_textStr: "這裡也是放一些文字，點點點。",
			init:function(){
				if(this._hasInitialized == false){
					var stageEl = $('#stage_3');
					this._textDom = stageEl.children(":last-child");
					this._hasInitialized = true;
				}
			},
			start:function(){
				var scope = this;
				scope._showInterval = {};
				var text = scope._textStr;
				for(var i = 0, len = text.length; i < len; i++){
					scope._showInterval[i.toString()] = setTimeout((function(str, dom){
						return function(){
							var textNode = document.createTextNode(str);
							dom.append(textNode);
						};
					})(text[i], scope._textDom), (i+1) * 200);
				}
			},
			stop: function(){
				for(var i in this._showInterval){
					clearInterval(this._showInterval[i]);
				}
				this._showInterval = null;
				this._textDom.empty();
			}
		};

		window.stage4Process = {
			_bombPositions: [
				280, 365, 160, 380, 356, 315, 420, 375, 590, 315, 500, 235, 400, 255,
				240, 350, 235, 385, 105, 385, 190, 382, 120, 365, 324, 300, 261, 285,
				288, 260, 570, 288, 535, 310, 480, 290, 485, 315, 480, 246, 525, 278,
				455, 239, 440, 258, 468, 277, 312, 276, 315, 250, 385, 310, 333, 360,
				323, 380, 358, 375, 386, 389, 386, 359, 409, 329, 414, 288, 383, 282,
				359, 279, 359, 244, 292, 311, 572, 348, 445, 305
			],
			_bombSrc: "images/04-bomb9.png",
			_exploSrc: "images/04-explosion.gif",
			_processInterval: null,
			_showInterval: null,
			_showSeconds: 3,
			_limitSeconds: 20,
			_timebar: null,
			_bombProcessAll:[],
			_bombShowing:[],
			_bombSelector: "div[b-n]",
			_bombAttrSelector: "b-n",
			_getValidIndex: function() {
				var min = 0,
					len = this._bombProcessAll.length,
					max = len - 1;
				if(len){
					return Math.floor(Math.random() * (max - min + 1) + min);
				}				
				return -1;
			},
			changeProperty: function(name, value){
				this[name] = value;
			},
			init:function(){
				var scope = this;
				var stage4El = $('#stage_4');
				var bp = scope._bombPositions;
				for(var i = 0, j = 0, len = bp.length; i < len; i+=2, j++){
					var str = '<div class="bomb" style="left:' + bp[i] + 'px;top:'
						+ bp[i+1] + 'px;" b-n="' + (j+1) + '">' +
	  					'<img class="b-body-part" width="100%" /><img class="b-explo-part" width="100%" /></div>';
					stage4El.append(str);
				}

				$(".b-body-part").attr('src', scope._bombSrc);

				$(".b-body-part").click(function(){
					var bombBody = $(this);
					var hasClicked = bombBody.attr('is-clicked');
					// console.log(hasClicked);
					if(hasClicked == 'true') return false;
					bombBody.attr('is-clicked', true);
					bombBody.attr('src', scope._exploSrc);
					setTimeout((function(bb){
						return function(){ 
							var id = bb.parent().attr("b-n");
							if(id){
								scope.stop(id);
								bb.attr('src', scope._bombSrc);
								bb.attr('is-clicked', false);
								// bb.show();
								// eb.hide();
							}
						};
					})(bombBody), 400);
				});

				var tb = this._timebar = TimeBar.getInstanceById('sketchSecond');
				tb.setSecond(this._limitSeconds);
			},
			start:function(){
				if(!this._processInterval && !this._showInterval){
					this._showInterval = {};
					this.__showCacheTempMaps = {};
					$(this._bombSelector).each((function(scope){
						return function(i,item){
							var id = item.getAttribute(scope._bombAttrSelector);
							scope.__showCacheTempMaps[id] = item;
							scope._bombProcessAll.push(id);
						};
					})(this));
					this._processInterval = setInterval((function(scope, s){
						return function(){	
							var idx = scope._getValidIndex();
							if(idx != -1){
								// console.log("validIndex: " + idx);
								var itemId = scope._bombProcessAll.splice(idx, 1)[0];
								// console.log("get Item id: " + itemId);
								scope._bombShowing.push(itemId);
								$(scope.__showCacheTempMaps[itemId]).show();
								// $("[" + scope._bombAttrSelector + "=" + itemId + "]").show();
								scope._showInterval[itemId] = setTimeout((function(id, outerScope){
									return function(){ 
										if(id) outerScope.stop(id);
									}
								})(itemId, scope), s * 1000);
							}
						};
					})(this, this._showSeconds), this._showSeconds * 1000 / 5);	
					this._timebar.resetBar();
					this._timebar.doStart((function(scope){
						return function(){ scope.stop(); };
					})(this));
				}
			},
			stop:function(itemId){
				var showingIndex;
				if(typeof itemId == 'undefined'){
					$(this._bombSelector).hide();
					clearInterval(this._processInterval);
					for(var i in this._showInterval){
						clearInterval(this._showInterval[i]);
					}
					// console.log("stop all");
					this._processInterval = null;
					this._showInterval = null;
					this.__showCacheTempMaps = null;
					this._bombProcessAll = [];
					this._bombShowing = [];	
				}else if((showingIndex = this._bombShowing.indexOf(itemId)) != -1 && this._showInterval[itemId]){
					clearInterval(this._showInterval[itemId]);
					this._showInterval[itemId] = null;
					$(this.__showCacheTempMaps[itemId]).hide();
					// $("[" + this._bombAttrSelector + "=" + itemId + "]").hide();
					// back to all
					this._bombShowing.splice(showingIndex, 1);
					// console.log("stop and push: " + itemId);
					this._bombProcessAll.push(itemId);
				}
			}
		};

		window.gamer = {
			_registerStages: [1, 2, 3, 4],
			_stageElSelector: ".stage",
			_stageNamePrefix: "stage_",
			_stageNumberRex: new RegExp("stage_(.*)"),
			_stageSelectProperty: "id",
			currentStage: 1,
			_getProcess: function(stage){
				return window["stage" + stage + "Process"];
			},
			// [ 'stage_1', '1', index: 0, input: 'stage_1' ]
			_findStage:function(el){
				var parentEl = $(el).parents(this._stageElSelector);
				if(parentEl){
					var prop = $(parentEl).attr(this._stageSelectProperty);
					var number = this._stageNumberRex.test(prop) ? prop.match(this._stageNumberRex)[1] : null;
					if(number) this.currentStage = number;
				}
			},
			initProcess:function(){
				var r = this._registerStages,
					i = 0,
					len = r.length;
				for(; i < len; i++){
					this._getProcess(r[i]).init();
				}
			},
			forceToStage: function(name){
				var currentProcess = this._getProcess(this.currentStage);
				if(currentProcess) currentProcess.stop();

				this.currentStage = name;
				// currentProcess.init();
				$('[' + this._stageSelectProperty + '^=' + this._stageNamePrefix + ']').hide();
				// $('[' + this._stageSelectProperty + '^=' + this._stageNamePrefix + name + ']').show();
				$('[' + this._stageSelectProperty + '^=' + this._stageNamePrefix + name + ']').fadeIn();
				currentProcess.start();
			},
			toNext: function(){
				if(typeof this.currentStage == 'undefined' || this.currentStage == null){
					// ???
				}
				var next = 1;
				// game transform logic
				$('[' + this._stageSelectProperty + '^=' + this._stageNamePrefix + this.currentStage + ']').hide();
				switch(this.currentStage){
					case 1:
					case 2:
					case 3:
						this._getProcess(this.currentStage).stop();
						this.currentStage++;
						this._getProcess(this.currentStage).start();
						break;
				}
				// transform animation or not
				$('[' + this._stageSelectProperty + '^=' + this._stageNamePrefix + this.currentStage + ']').show();
			}
		};

		

		window.isFirstTime = (function(){
			function getCookie(name) {
				var value = "; " + document.cookie;
				var parts = value.split("; " + name + "=");
				if (parts.length == 2) return parts.pop().split(";").shift();
				return null;
			}
			function createCookie(name,value,days) {
			    if (days) {
			        var date = new Date();
			        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
			        var expires = "; expires=" + date.toGMTString();
			    }
			    else var expires = "";
			    document.cookie = name + "=" + value + expires + "; path=/";
			}
			var c = getCookie("_hakka");
			var isft = (c && c == "yes");
			createCookie("_hakka", "yes", 365);
			return !isft;
		})();

		$(window).load(function(){

			gamer.initProcess();

			$(".next-stage").click(function(){
				gamer.toNext();
			});
		});

		$(document.body).ready(function(){
			$(".prepare").empty();
			setTimeout(function(){
				gamer.forceToStage(1);
			},600 + (isFirstTime? 2200 : 0));
		});
  	</script>
  </head>
  <body>
  	<div class="prepare">
  		<span class="font-zhuin">一二三四五六七八九十</span>
  		<span class="font-zhuin-poin1">著被數</span>
  		<span class="font-zhuin-poin2">著數</span>
  		<img width="100%" src="images/01-intro-firework-stop.png"/>
  		<img width="100%" src="images/01-intro-firework.gif"/>
  		<img width="100%" src="images/04-bomb9.png"/>
  		<img width="100%" src="images/04-explosion.gif"/>
  	</div>
  	<!-- <div class="font-zhuin">沒什麼事</div> -->
  	<div id="stage_prepare" class="stage stage-loading" style="display:block;">
  		Loading...
  	</div>
  	<div id="stage_1" class="stage stage-intro">
  		<div class="intro-back">
  			<img src="images/01-intro-back.png" width="100%" />
  		</div>
  		<div class="intro-dragon">
  			<img src="images/01-intro-dragon.gif" width="100%" />
  		</div>
  		<div class="intro-girl">
  			<img src="images/01-intro-girl.gif" width="100%" />
  		</div>
  		<div class="next-stage button-intro-enter"></div>

  		<!-- for the bugs -->
  		<!-- <div class="intro-firework" style="left: 120px; top: 20px; display: none;" f-n="1">
  			<img width="100%" src="images/01-intro-firework-stop.png">
  		</div>
  		<div class="intro-firework" style="left: 348px; top: 0px; display: none;" f-n="2">
  			<img width="100%" src="images/01-intro-firework-stop.png">
  		</div>
  		<div class="intro-firework" style="left: 590px; top: 0px; display: none;" f-n="3">
  			<img width="100%" src="images/01-intro-firework-stop.png">
  		</div>
  		<div class="intro-firework" style="left: 385px; top: 210px; display: none;" f-n="4">
  			<img width="100%" src="images/01-intro-firework-stop.png">
  		</div>
  		<div class="intro-firework" style="left: 320px; top: 369px; display: none;" f-n="5">
  			<img width="100%" src="images/01-intro-firework-stop.png">
  		</div>
  		<div class="intro-firework" style="left: 590px; top: 260px; display: none;" f-n="6">
  			<img width="100%" src="images/01-intro-firework-stop.png">
  		</div> -->

  	</div>
  	<div id="stage_2" class="stage stage-message">
  		<div class="message-dialog">
  			<img src="images/02-message-dialog.png" width="100%" />
  		</div>
  		<div class="message-oldman">
  			<img src="images/02-message-oldman.gif" width="100%" />
  		</div>
  		<div class="message-text font-zhuin"></div>
  	</div>
  	<div id="stage_3" class="stage stage-rules">
  		<div class="rules-oldman">
  			<img src="images/02-message-oldman.gif" width="100%" />
  		</div>
  		<div class="next-stage button-rules-enter"></div>
  		<div class="rules-text font-zhuin"></div>
  	</div>
  	<div id="stage_4" class="stage stage-bomb">
  		<div class="timebar">
  			<div class="HP_bar"> 
		      <div id="sketchSecond" class="HP_bar_inner" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%;">
		      </div>
		    </div>	
  		</div>
  		
  		<!-- <div class="background-temp">
  			<img src="images/04-backtemp.jpg" width="100%;" />
  		</div> -->

  		<!-- <div class="ballman">
  			<img src="images/04-ballman.png" width="100%" />
  		</div> -->
  		
  		<!-- <div class="people">
  			<img src="images/04-people.png" align="center" width="100%;">
  		</div> -->
  		<div class="dragon-head">
  			<img src="images/04-head.png" width="100%;">
  		</div>
  		<div class="font-zhuin b-counter">0</div>
  		<div class="font-zhuin score-counter">00000</div>
  	</div>
  </body>
</html>
